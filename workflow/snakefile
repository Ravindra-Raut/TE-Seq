################### NEW SNAKE
import os
import pandas as pd
import csv
from pathlib import Path
from pandas.core.common import flatten

configfile: "conf/config.yaml"

final_input = []
for pipeline in config["pipelines_to_deploy"]:
    if pipeline == "aref":
        module aref:
            snakefile: "aref/snakefile"
            config: config["aref"]
        if config["aref"]["symlink_aref"]["response"] == "yes":
            use rule sym_link from aref as aref_*
            final_input.append("aref.done.outfile")
        else:
            final_input.append("aref.done.outfile")
            if config["aref"]["update_ref_with_tldr"]["response"] == "yes":
                if config["aref"]["update_ref_with_tldr"]["per_sample"] == "yes":
                    use rule * from aref exclude sym_link,tldr_aggregate_multiple_samples,merge_bams_when_per_sample_is_no_for_ldna_variants as aref_*
                else: 
                    use rule * from aref exclude sym_link,move_starting_reference,tldr_per_sample,get_repeatmasker_raw,process_gtf as aref_*
            else:
                use rule * from aref exclude sym_link,dorado,dorado_seqsummary,pycoQC,process_gtf_tldr,cleanup_updated_ref,repeatmasker,getGtfs as aref_*

    if pipeline == "ldna":
        module ldna:
            snakefile: "ldna/snakefile"
            config: config
        if config["ldna"]["use_aref_basecalls"] == "yes":
            use rule * from ldna exclude dorado,dorado_seqsummary,pycoQC as ldna_*
        else:
            use rule * from ldna exclude align_to_updated_ref as ldna_*
            tldr_analysis_per_sample = expand("ldna/tldr/{sample}.table.txt", sample = config["ldna"]["samples"])
            pycoQC = expand("ldna/qc/{sample}/{sample}pycoQC.html", sample = config["ldna"]["samples"])
            final_input.append(list(flatten([tldr_analysis_per_sample, pycoQC])))
        dmrs = "ldna/results/tables/dmrs.CG_m.tsv",
        haplotaggedbam = expand("ldna/intermediates/{sample}/alignments/{rate}/{sample}.{type}.{modification_string}.sorted.filtered.haplotagged.bam", rate = config["ldna"]["rate"], type = config["ldna"]["type"], modification_string = config["ldna"]["modification_string"], sample = config["ldna"]["samples"])
        bedmethanalysis = "ldna/outfiles/bedmethylanalysis.txt"
        bedmethanalysis_single_sample = "ldna/outfiles/bedmethylanalysis_single_sample.txt"
        sniffles = expand("ldna/intermediates/{sample}/sniffles/sniffles.vcf", sample = config["ldna"]["samples"])
        clair3 = expand("ldna/intermediates/{sample}/clair3/full_alignment.vcf.gz", sample = config["ldna"]["samples"])
        methylartist = "ldna/results/plots/methylartist/locus/methylartistlocusplot_loci_of_interest.outfile"
        gimme = "ldna/results/gimme/gimme_plots.rds"
        pepper_aref = expand("ldna/intermediates/{sample}/pepper/out.outfile", sample = config["ldna"]["samples"])
        variants_aref = expand("ldna/intermediates/{sample_or_ref}/snpeff/snpeff_sml.pass.vcf", sample_or_ref = "A.REF")
        variants_per_sample = expand("ldna/intermediates/{sample_or_ref}/snpeff/snpeff_sml.pass.vcf", sample_or_ref = config["ldna"]["samples"])
        if config["ldna"]["single_condition"] == "yes":
            for e in list(flatten([bedmethanalysis_single_sample, methylartist])):
                final_input.append(e)
        else:
            for e in list(flatten([bedmethanalysis,dmrs, methylartist])):
                final_input.append(e)
        if config["aref"]["update_ref_with_tldr"]["response"] == "yes":
            if config["aref"]["update_ref_with_tldr"]["per_sample"] == "yes":
                for e in list(flatten([variants_per_sample])):
                    final_input.append(e)
            else:
                for e in list(flatten([variants_aref])):
                    final_input.append(e)

    if pipeline == "lrna":
        module lrna:
            snakefile: "lrna/snakefile"
            config: config["lrna"]
        use rule * from lrna as lrna_*
        def lrna_rally():
            deseq = expand("lrna/results/agg/deseq/{counttype}/{contrast}/results_genes.csv", alignmenttype = config["lrna"]["alignmenttypes"], counttype = config["lrna"]["counttypes"], contrast = config["lrna"]["contrasts"])
            enrichment_analysis = "lrna/results/agg/enrichment_analysis/enrichment_analysis_environment.RData"
            enrichment_analysis_repeats = expand("lrna/results/agg/enrichment_analysis_repeats/{counttype}/enrichment_analysis_repeats_environment.RData", alignmenttype = config["lrna"]["alignmenttypes"], counttype = config["lrna"]["counttypes"])
            repeatanalysisplots = expand("lrna/results/agg/repeatanalysis/{counttype}/repeatanalysisplots_environment.RData", alignmenttype = config["lrna"]["alignmenttypes"], counttype = config["lrna"]["counttypes"])
            # genomebrowserplots = expand("lrna/outfiles/genomebrowserplots{alignmenttype}.out", alignmenttype = config["lrna"]["alignmenttypes"])
            qc = [expand("lrna/qc/mycoplasma/mycoplasma{sample}.bam", sample = config["lrna"]["samples"]), "lrna/qc/multiqc_report.html"]
            bw = [expand("lrna/intermediates/{sample}/alignments/{rate}/{sample}.{type}.{modification_string}.F.bw", sample = config["lrna"]["samples"], rate = config["lrna"]["rate"],  type = config["lrna"]["type"], modification_string = config["lrna"]["modification_string"]), expand("lrna/intermediates/{sample}/alignments/{rate}/{sample}.{type}.{modification_string}.R.bw", sample = config["lrna"]["samples"], rate = config["lrna"]["rate"],  type = config["lrna"]["type"], modification_string = config["lrna"]["modification_string"])]
            # bw, enrichment_analysis, enrichment_analysis_repeats
            return list(flatten([deseq, qc, enrichment_analysis, enrichment_analysis_repeats, repeatanalysisplots]))

        for e in lrna_rally():
            final_input.append(e)

    if pipeline == "srna":
        module srna:
            snakefile: "srna/snakefile"
            config: config["srna"]
        if config["srna"]["library_type"] == "PE":
                use rule * from srna exclude fastp_SE,alignSTAR_SE,featurecounts_genes_SE,featurecounts_genesandrtes_SE as srna_*
        else:
                use rule * from srna exclude fastp_PEalignSTAR_PE,featurecounts_genes_PE,featurecounts_genesandrtes_PE as srna_*

        if config["srna"]["downsample_for_test"]["response"] == "yes":
            use rule fastp_PE from srna as srna_fastp_PE with:
                input:
                    r1 = "srna/outs/{sample}/subsampled/{sample}_1.subsampled.fastq.gz",
                    r2 = "srna/outs/{sample}/subsampled/{sample}_2.subsampled.fastq.gz"

        samples = config["srna"]["samples"]
        counttypes = config["srna"]["counttypes"]
        contrasts = config["srna"]["contrasts"]
        counttypes = config["srna"]["counttypes"]

        def srna_rally():
            deseq = expand("srna/results/agg/deseq/{counttype}/{contrast}/results_genes.csv", counttype = config["srna"]["counttypes"], contrast = config["srna"]["contrasts"])
            enrichment_analysis = "srna/results/agg/enrichment_analysis/enrichment_analysis_environment.RData"
            enrichment_analysis_repeats = expand("srna/results/agg/enrichment_analysis_repeats/{counttype}/enrichment_analysis_repeats_environment.RData", counttype = config["srna"]["counttypes"])
            repeatanalysisplots = expand("srna/results/agg/repeatanalysis/{counttype}/repeatanalysisplots_environment.RData", counttype = config["srna"]["counttypes"])
            bigwigs = "srna/results/agg/bigwig_plots/bigwigplots_environment.RData"
            qc = [expand("srna/qc/mycoplasma/mycoplasma{sample}.sam", sample = config["srna"]["samples"]), "srna/qc/multiqc/multiqc_report.html"]
            return list(flatten([bigwigs, deseq, enrichment_analysis, enrichment_analysis_repeats, repeatanalysisplots, qc]))
       
        for e in srna_rally():
            final_input.append(e)

# module ldna:
#     snakefile:
#         github("maxfieldk/pipeline", path="workflow/ldna/snakefile", tag="v0.1.0")
#     config:
#         config["ldna"]


rule all:
    input:
        [
            # expand("ldna/qc/{sample}/{sample}pycoQC.html", sample = config["ldna"]["samples"])
            
            final_input            
            ]
    default_target: True


include: "rules.smk"